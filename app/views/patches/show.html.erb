<h2><%= @patch.name %></h2>

<p><% if @patch.game != '' %>
      <%= 'FROM THE GAME: ' + @patch.game %>
    <% end %></p>

<p><% if @patch.original == true %>
      <%= "Original Patch By " %> <%= link_to @patch.user.username, user_path(@patch.user) %>
    <% end %></p>

<p><% if @patch.description != '' %>
      <%= "Description: " + @patch.description %>
    <% end %></p>

<p>CATEGORIES: <% @patch.categories.each do |p| %>
                  <%= p.name %>
                <% end %></p>

<p><%= link_to 'Download', @patch.file.url %></p>

<p><% if current_user == @patch.user %>
      <%= link_to 'Edit', edit_user_patch_path(@patch.user, @patch) %>
    <% end %></p>

<p><% if current_user == @patch.user %>
      <%= link_to 'Delete', user_destroy_patch_path(@patch.user, @patch) %>
    <% end %></p>

<%= form_tag("#", method: 'post', id: "newComment", :"data-userid" => current_user.id, :"data-patchid" => @patch.id) do %>
  <%= text_field_tag(:comment_content) %>
  <%= submit_tag("Post Comment", :"data-disable-with" => false) %>
<% end %>

<div id="comments"></div>

<script>
  $(document).ready(function (){
    class Comment {
      constructor(content, userid, patchid) {
        this.content = content
        this.userid = userid
        this.patchid = patchid
      }

      makeJson(){
        return { comment: {user_id: `${this.userid}`, patch_id: `${this.patchid}`, content: `${this.content}`} }
      }

      createDiv(content, username) {
        return `<div class="comment"><p>${content}</p><p>Posted By: ${username}</p>`
      }
    }

    const COMMENTS = []

    $.ajax({
      type: "GET",
      url: window.location.pathname,
      dataType: "json"
    }).done(function(resp){
      resp.comments.forEach(function(value, index){
        let comment = new Comment(value.content, value.patch_id, value.user_id)
        COMMENTS.push(comment)
      })
    }).done(function(){
      COMMENTS.forEach(function(value){
        $.ajax({
          type: "GET",
          url: `/users/${value.userid}`,
          dataType: "json"
        }).done(function(resp){
          $('#comments').prepend(value.createDiv(value.content, resp.username))
        })
      })
    })


    $('#newComment').submit( function (e){
      e.preventDefault()

      var newComment = new Comment($('#comment_content').val(), this.attributes[1].value, this.attributes[2].value)
      var token = this[2].value
      let data = newComment.makeJson()

      $.ajax({
        type: "POST",
        url: '/comments',
        data: data,
        authenticity_token: token,
        dataType: "json"
      })
      .done(function(resp) {
        $('#comments').prepend( () => newComment.createDiv(resp.content, resp.user.username))
        $('input#comment_content')[0].value = ''
       })
     })
  });
</script>
